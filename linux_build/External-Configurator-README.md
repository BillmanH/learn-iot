# External-Configurator.ps1

PowerShell script for configuring Azure resources and deploying Azure IoT Operations from a Windows management machine.

## Overview

This script is part of the **Separation of Concerns** architecture where:
- **linux_installer.sh** runs on the edge device (Linux/K3s setup)
- **External-Configurator.ps1** runs on a Windows management machine (Azure/Arc configuration)

## Prerequisites

### On Windows Management Machine

1. **Operating System**
   - Windows 10/11 or Windows Server 2019+

2. **PowerShell**
   - PowerShell 5.1 or later
   - PowerShell 7+ recommended

3. **Azure CLI**
   - [Install Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-windows)
   - Version 2.50+ required
   - IoT Operations extension: `az extension add --name azure-iot-ops`

4. **kubectl**
   - [Install kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl-windows/)
   - Used for remote cluster management

5. **Azure Permissions**
   - Contributor or Owner role on target subscription
   - Permissions to create Arc-enabled Kubernetes clusters
   - Permissions to register resource providers

6. **Network Access**
   - Connectivity to edge device (for kubectl commands via port 6443)
   - Outbound internet access for Azure API calls

### From Edge Device

- `cluster_info.json` - Cluster details and kubeconfig (generated by linux_installer.sh)
- `linux_aio_config.json` - Azure configuration used during edge installation

**Recommended location**: Place both files in `linux_build\edge_configs\` directory

## Installation

1. Clone this repository or download the script files:
   ```powershell
   cd C:\repos\learn-iothub\linux_build
   ```

2. Ensure Azure CLI is installed and logged in:
   ```powershell
   az version
   az login
   ```

3. Copy configuration files from your edge device:
   ```powershell
   # Create edge_configs directory if it doesn't exist
   mkdir edge_configs -ErrorAction SilentlyContinue
   
   # Then copy files from edge device (via USB, SCP, or other method)
   # Target location: linux_build\edge_configs\
   #   - cluster_info.json
   #   - linux_aio_config.json
   ```

## Configuration

### Option 1: Automatic (Recommended)

The script automatically searches for `linux_aio_config.json` in these locations:
1. `linux_build/edge_configs/linux_aio_config.json` (checked first)
2. `linux_build/linux_aio_config.json` (fallback)

If found, it uses the configuration from your edge device installation.

```powershell
# Simply run with cluster_info.json - it will find linux_aio_config.json automatically
.\External-Configurator.ps1 -ClusterInfo edge_configs\cluster_info.json -ConfigFile edge_configs\linux_aio_config.json
```

### Option 2: Interactive Mode

If `linux_aio_config.json` is not found, the script will prompt you:
- Continue in interactive mode (enter values manually)
- Exit and copy the config file first

```powershell
.\External-Configurator.ps1
# Will prompt for Azure values if config not found
```

### Option 3: Custom Configuration File

Specify a different configuration file:

```powershell
.\External-Configurator.ps1 -ConfigFile path\to\custom_config.json
```

### Copying Files from Edge Device

After running `linux_installer.sh` on your edge device:

**Option A: USB Backup (Easiest)**
```bash
# On edge device
./backup_aio_configs.sh
# This backs up cluster_info.json and linux_aio_config.json to USB

# Then on Windows, copy from USB to:
# linux_build\edge_configs\
```

**Option B: SCP**
```powershell
# From Windows machine
scp user@edge-device:/path/to/linux_build/cluster_info.json .\edge_configs\
scp user@edge-device:/path/to/linux_build/linux_aio_config.json .\edge_configs\
```

**Option C: Manual Copy**
- Copy files via network share, email, or other method
- Place in `linux_build\edge_configs\` directory

## Usage

### Basic Usage

```powershell
# Automatic mode (searches for linux_aio_config.json and cluster_info.json in edge_configs folder)
.\External-Configurator.ps1

# Specify cluster info explicitly
.\External-Configurator.ps1 -ClusterInfo cluster_info.json

# Use custom config file
.\External-Configurator.ps1 -ConfigFile path\to\custom_config.json
```

### Advanced Options

```powershell
# Dry run (validate without making changes)
.\External-Configurator.ps1 -DryRun

# Skip Arc enablement (if cluster already Arc-enabled)
.\External-Configurator.ps1 -SkipArcEnable

# Skip post-deployment verification
.\External-Configurator.ps1 -SkipVerification

# Skip Key Vault setup (if you don't need secret management)
.\External-Configurator.ps1 -SkipKeyVault

# Combine options
.\External-Configurator.ps1 -ConfigFile custom_config.json -SkipArcEnable
```

## What It Does

**Note**: The script automatically searches for `cluster_info.json` and `linux_aio_config.json` in the `edge_configs/` folder. If not found, it checks the `linux_build/` folder as a fallback.

### Phase 1: Prerequisites & Configuration
- Validates PowerShell version (5.1+)
- Checks Azure CLI installation
- Verifies kubectl availability
- Automatically locates and loads cluster_info.json (searches edge_configs/ first)
- Automatically locates and loads linux_aio_config.json (searches edge_configs/ first)
- Falls back to interactive mode if linux_aio_config.json not found

### Phase 2: Azure Authentication
- Checks existing Azure login status
- Initiates `az login` if needed
- Sets target subscription
- Prompts for missing configuration values

### Phase 3: Cluster Connectivity
- Decodes kubeconfig from cluster_info.json
- Configures kubectl for remote cluster access
- Tests connectivity to edge K3s cluster

### Phase 4: Azure Resource Creation
- Creates resource group (if not exists)
- Prepares Azure environment

### Phase 5: Arc Enablement
- Connects K3s cluster to Azure Arc
- Enables custom locations feature
- Enables cluster connect feature
- Configures Arc-enabled Kubernetes cluster

### Phase 6: IoT Operations Deployment
- Initializes cluster for Azure IoT Operations
- Registers required resource providers (Microsoft.Storage, etc.)
- Creates schema registry with storage account
- Creates Device Registry namespace
- Deploys Azure IoT Operations instance
- Enables edge-to-cloud asset sync (rsync)

### Phase 6.5: Key Vault Integration (NEW)
- Creates Azure Key Vault for secret management
- Grants permissions to Arc cluster and AIO managed identities
- Creates SecretProviderClass on Kubernetes cluster
- Enables secure secret references in dataflows
- Optional: Prompts to add sample secrets interactively

### Phase 7: Verification
- Verifies resource group creation
- Checks Arc connection status
- Validates IoT Operations instance
- Lists cluster resources

### Phase 8: Summary
- Generates deployment_summary.json
- Displays completion summary with portal links
- Lists deployed resources
- Reports any errors encountered

## Output Files

### external_configurator_YYYYMMDD_HHMMSS.log
Complete transcript of script execution with timestamps.

### deployment_summary.json
JSON file containing:
- Deployment timestamp
- Cluster details
- Azure configuration
- Deployed resources list
- Errors (if any)

Example:
```json
{
  "timestamp": "2026-01-24T10:30:00.000Z",
  "cluster_name": "home-nuc-1",
  "azure": {
    "subscription_id": "xxx",
    "resource_group": "my-rg",
    "location": "eastus"
  },
  "deployment": {
    "deployed_resources": [
      "ResourceGroup:my-rg",
      "ConnectedCluster:home-nuc-1",
      "SchemaRegistry:home-nuc-1-schema-registry",
      "IoTOperationsInstance:home-nuc-1-aio"
    ],
    "errors": []
  }
}
```

## Troubleshooting

### Cannot connect to cluster

**Error**: `Cannot connect to cluster. Please ensure network connectivity to edge device.`

**Solutions**:
1. Verify network connectivity to edge device:
   ```powershell
   Test-NetConnection -ComputerName <edge-device-ip> -Port 6443
   ```

2. Ensure K3s is running on edge device:
   ```bash
   sudo systemctl status k3s
   ```

3. Check kubeconfig has correct server IP in cluster_info.json

4. If using VPN, ensure VPN is connected

5. Firewall may be blocking port 6443:
   ```bash
   # On Linux edge device
   sudo ufw allow 6443/tcp
   ```

### Azure CLI not found

**Error**: `Azure CLI is not installed or not in PATH`

**Solution**:
```powershell
# Install Azure CLI
winget install Microsoft.AzureCLI

# Or download from:
# https://aka.ms/installazurecliwindows

# Restart PowerShell after installation
```

### Arc enablement fails

**Error**: `Failed to Arc-enable cluster`

**Common causes**:
1. **Network connectivity**: Ensure outbound internet access from edge device
2. **Permissions**: Verify Azure account has sufficient permissions
3. **Resource providers**: May need to register Microsoft.Kubernetes provider:
   ```powershell
   az provider register --namespace Microsoft.Kubernetes
   az provider register --namespace Microsoft.KubernetesConfiguration
   az provider register --namespace Microsoft.ExtendedLocation
   ```

4. **Existing Arc connection**: Cluster may already be Arc-enabled:
   ```powershell
   # Check existing Arc connections
   az connectedk8s list --resource-group <rg-name>
   
   # Use -SkipArcEnable flag if already connected
   .\External-Configurator.ps1 -ClusterInfo cluster_info.json -SkipArcEnable
   ```

### Schema registry creation fails

**Error**: `Failed to create schema registry`

**Solutions**:
1. Ensure Microsoft.Storage provider is registered (script does this automatically)
2. Verify storage account name is unique and valid (lowercase, alphanumeric, max 24 chars)
3. Check subscription has available storage account quota

### Asset sync fails

**Warning**: `Failed to enable asset sync automatically`

**Solutions**:
1. **Ignore if not needed**: Asset sync is optional
2. **Manual enablement**: Try after deployment completes:
   ```powershell
   az iot ops enable-rsync --name <instance-name> --resource-group <rg-name>
   ```
3. **Check K8 Bridge service principal**: May need manual OID lookup
4. **Retry later**: Sometimes succeeds after IoT Operations fully provisions

## Common Workflows

### First-Time Setup

```powershell
# 1. Ensure prerequisites
az --version
kubectl version --client

# 2. Copy cluster_info.json and linux_aio_config.json from edge device
# Place them in: linux_build\edge_configs\
# (via USB backup, SCP, or other method)

# 3. Run configurator - it will auto-detect the config files
.\External-Configurator.ps1

# The script automatically finds:
# - edge_configs\cluster_info.json
# - edge_configs\linux_aio_config.json
```

### Re-running After Failure

```powershell
# Script is idempotent - safe to re-run
# It checks for existing resources before creating

.\External-Configurator.ps1

# Or skip already-completed steps
.\External-Configurator.ps1 -SkipArcEnable
```

### Testing Configuration (Dry Run)

```powershell
# Validate configuration without making changes
.\External-Configurator.ps1 -DryRun
```

### Managing Multiple Clusters

```powershell
# Organize configs in separate folders
mkdir edge_configs\cluster1
mkdir edge_configs\cluster2

# Copy configs from each edge device to respective folders

# Deploy to cluster 1
.\External-Configurator.ps1 -ClusterInfo edge_configs\cluster1\cluster_info.json -ConfigFile edge_configs\cluster1\linux_aio_config.json

# Deploy to cluster 2
.\External-Configurator.ps1 -ClusterInfo edge_configs\cluster2\cluster_info.json -ConfigFile edge_configs\cluster2\linux_aio_config.json
```

## Execution Policy

If you encounter execution policy errors:

```powershell
# Check current policy
Get-ExecutionPolicy

# Set policy for current user (recommended)
Set-ExecutionPolicy -ExecutionPolicy RemoteSired -Scope CurrentUser

# Or run with bypass (less secure)
powershell.exe -ExecutionPolicy Bypass -File .\External-Configurator.ps1
```

## Integration with linux_installer.sh

This script is designed to work with `linux_installer.sh`:

1. **On Linux edge device**: Run `linux_installer.sh`
   - Installs K3s
   - Deploys modules (optional)
   - Generates `cluster_info.json` and uses `linux_aio_config.json`

2. **Transfer files to Windows machine**:
   - Copy `cluster_info.json` and `linux_aio_config.json`
   - Place in `linux_build\edge_configs\` directory
   - Use USB backup (`backup_aio_configs.sh`), SCP, or manual copy

3. **On Windows management machine**: Run `External-Configurator.ps1`
   - Arc-enables cluster
   - Deploys Azure IoT Operations
   - Configures cloud resources

## Script Architecture

### Functions Overview

- **Logging**: `Write-Log`, `Write-ErrorLog`, `Write-Success`, etc.
- **Prerequisites**: `Test-Prerequisites`
- **Configuration**: `Import-ClusterInfo`, `Import-AzureConfig`
- **Authentication**: `Connect-ToAzure`
- **Cluster**: `Initialize-KubeConfig`
- **Azure Resources**: `New-AzureResources`
- **Arc**: `Enable-ArcForCluster`
- **IoT Operations**: `New-IoTOperationsInstance`, `New-SchemaRegistry`, `New-DeviceRegistryNamespace`
- **Asset Sync**: `Enable-ResourceSync`
- **Verification**: `Test-Deployment`
- **Summary**: `Export-DeploymentSummary`, `Show-CompletionSummary`

### Error Handling

- Try/catch blocks for critical operations
- Error tracking in `$script:Errors` array
- Fatal errors exit with error code 1
- Non-fatal errors logged but allow continuation

### Idempotency

The script checks for existing resources before creating:
- Resource groups
- Arc connections
- IoT Operations instances
- Schema registries
- Storage accounts

Safe to run multiple times.

## Next Steps After Deployment

1. **Verify in Azure Portal**
   - Navigate to resource group
   - Check Arc-enabled cluster status
   - View Azure IoT Operations instance
   - Verify Key Vault was created

2. **Add Secrets to Key Vault** (for Fabric RTI or secure endpoints)
   ```powershell
   az keyvault secret set --vault-name <kv-name> --name fabric-connection-string --value "Endpoint=..."
   ```
   See [KEYVAULT_INTEGRATION.md](KEYVAULT_INTEGRATION.md) for details

3. **Monitor Cluster Resources**
   ```powershell
   kubectl get pods --all-namespaces
   kubectl get nodes
   ```

4. **Deploy MQTT Assets** (if applicable)
   - Use ARM templates in `arm_templates/` directory
   - See `iotopps/edgemqttsim/README.md` for examples

5. **Configure Dataflows**
   - Set up data routing in Azure portal
   - Deploy fabric dataflows if using Microsoft Fabric
   - Reference secrets as: `aio-akv-sp/<secret-name>`

6. **Test MQTT Connectivity**
   ```powershell
   kubectl logs -n default -l app=mosquitto-sub -f
   ```

## Support

For issues or questions:
- Check logs: `external_configurator_*.log`
- Review deployment summary: `deployment_summary.json`
- Consult Azure IoT Operations documentation
- See `IOT_TROUBLESHOOTING.md` in project root

## Version History

- **1.0.0** (2026-01-24) - Initial release with separation of concerns architecture

## Related Files

- `linux_installer.sh` - Edge device setup script (generates config files)
- `linux_aio_config.json` - Azure configuration from edge device (in edge_configs/)
- `cluster_info.json` - Cluster details with kubeconfig (in edge_configs/)
- `backup_aio_configs.sh` - USB backup utility for config files
- `separation_of_concerns.md` - Architecture documentation
- `deployment_summary.json` - Output from deployment
- `KEYVAULT_INTEGRATION.md` - Key Vault setup and usage guide
- `CSI_SECRET_STORE_SETUP.md` - CSI driver prerequisites
